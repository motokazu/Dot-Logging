<!DOCTYPE html>
<html>
  <head>
    <title>Dot Logging - CouchApp</title>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.css" />
	<script src="http://code.jquery.com/jquery-1.5.2.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.0a4.1/jquery.mobile-1.0a4.1.min.js"></script>
	<script src="js/jquery.flot.min.js"></script>
	<script src="/_utils/script/json2.js"></script>
  </head>
  <body>
	<div data-role="page" id="top">
		<div data-role="header">
			<h1 id="dot_logging_-_top">Dot Logging - Top</h1>
		</div>
		<div data-role="content">
			<p>let's log dots.</p>
			<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">
				<li><a href="#logdot">dot.</a></li>
				<li><a href="#graph-top">View Graph</a></li>
			</ul>
		</div>
		<div data-role="footer">
			Dot Logging
		</div>
	</div>
	<div data-role="page" id="logdot">
		<div data-role="header">
			<h1 id="dot_logging_-_logdot">Dot Logging - logdot</h1>
		</div>
		<div data-role="content">
			<p>Push button if you log the dot.</p>
			<input type="submit" name="postdot" value="dot!" id="postdot"><br>
			<span id="dotmsg"></span>
		</div>
		<div data-role="footer">
			Dot Logging
		</div>
	</div>
	<div data-role="page" id="graph-top">
		<div data-role="header">
			<h1 id="dot_logging_-_graph">Dot Logging - Graph</h1>
		</div>
		<div data-role="content">
			<ul data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">
				<li data-role="list-divider">Graph Range</li>
				<li><a href="#graph-today">Today</a></li>
				<li><a href="#graph-all">All data</a></li>
			</ul>
		</div>
		<div data-role="footer">
			Dot Logging
		</div>	
	</div>
	<div data-role="page" id="graph-today">
		<div data-role="header">
			<h1 id="dot_logging_-_graph">Dot Logging - Graph Today</h1>
		</div>
		<div data-role="content">
			<div id="placeholder-today" style="widt100%;height:250px;"></div> 
			<br><input type="button" id="plotgraph-today" value="replot"><br>
		</div>
		<div data-role="footer">
			Dot Logging
		</div>	
	</div>
	<div data-role="page" id="graph-all">
		<div data-role="header">
			<h1 id="dot_logging_-_graph">Dot Logging - Graph All</h1>
		</div>
		<div data-role="content">
			<div id="placeholder-all" style="width:100%;height:250px;"></div> 
			<br><input type="button" id="plotgraph-all" value="replot"><br>
		</div>
		<div data-role="footer">
			Dot Logging
		</div>	
	</div>
  </body>

<script id="source"> 
$(function () {
	// plot graph
	plot_GraphAll();
	plot_GraphToday();
	
	// bind post function to dot
	$("#postdot").click(function(){
		var json = {"stime":null, "type":"cough"};
		var d = new Date();
		json.stime = d.getTime();
		$.ajax({
			type: 'POST',
			dataType: 'json',
			url: "/dots/",
			contentType: 'application/json',
			data: JSON.stringify(json),
			processData: false,		
			success: function(data, dataType){
				//alert("ok post");
				$("#dotmsg").text("post ok("+data.ok+") dot as "+data.id);
			},
			error: function(msg){
				alert("Failed.");
			}
		});
	});
	
	$("#plotgraph-all").click(function(){
		plot_GraphAll();
	});
	$("#plotgraph-today").click(function(){
		plot_GraphToday();
	});
});

function plot_GraphAll(){
	plot_Graph("cough",4,"placeholder-all");
}

function plot_GraphToday(){
	var d = new Date();
	var daybase = "["+d.getFullYear()+","+(d.getMonth()+1)+","+d.getDate();
	var startkeystr = daybase + ",0]";
	var endkeystr = daybase + ",23]";
	plot_Graph("cough",4,"placeholder-today",startkeystr, endkeystr );
}

function plot_Graph(type,level,plotto,startkey,endkey){
	var datasets = [];
	var tempd = {};
	
	// set default params
	var _type = "all";
	var _level = 5;
	var _plotto = "placeholder";
	var _startkey = "";
	var _endkey = "";

	if ( null !== type && undefined !== type ) {
		_type = type;
	}
	if ( null !== level && undefined !== level ) {
		_level = level;
	}
	if ( null !== plotto && undefined !== plotto ) {
		_plotto = plotto;
	}
	if ( null !== startkey && undefined !== startkey ) {
		_startkey = "&startkey="+startkey;
	}
	if ( null !== endkey && undefined !== endkey ) {
		_endkey = "&endkey="+endkey;
	}
	
	// generate uri
	var uri = "/dots/_design/dotlgng/_view/"+_type+"?group=true&group_level="+_level+_startkey+_endkey;
	
	$.ajax({
		type: 'GET',
		dataType: 'json',
		url: uri,
		success: function(data){
			$.each(data.rows, function(id, val){
				var stime = val.value.stime;
				stime = stime + 32400000; //fix to JST , this is temporary code.
				var count = val.value.count;
				
				// create array for dataset
				if ( !tempd[_type] ) {
					tempd[_type] = [];
				}
				tempd[_type].push([stime,count]);
			});
			
			// push all data
			$.each(tempd, function(type, dataset){
				datasets.push({"label":type,data:dataset});				
			});

			// helper for returning the weekends in a period
		    function weekendAreas(axes) {
		        var markings = [];
		        var d = new Date(axes.xaxis.min);
		        // go to the first Saturday
		        d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 1) % 7))
		        d.setUTCSeconds(0);
		        d.setUTCMinutes(0);
		        d.setUTCHours(0);
		        var i = d.getTime();
		        do {
		            // when we don't set yaxis, the rectangle automatically
		            // extends to infinity upwards and downwards
		            markings.push({ xaxis: { from: i, to: i + 1 * 24 * 60 * 60 * 1000} });
		            i += 1 * 24 * 60 * 60 * 1000;
		        } while (i < axes.xaxis.max);

		        return markings;
		    }
			
			var options = {
		        xaxis: { mode: "time" },
		        selection: { mode: "x" },
		        grid: { markings: weekendAreas },
				yaxis: { min: 0 },
            	legend: { position: 'sw' },
				series: {
					bars: { show: true, barWidth: 0.6 }
				}
		    };
			
			$.plot($("#"+_plotto), datasets, options);
		}
	});
}
</script>

</html>